<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile Page</title>
  <link rel="icon" type="image/png" href="images/favicon.png" />
</head>
<body>

<h2 id="username">User</h2>

<div id="profile-container">
  <img id="profilePic" src="" alt="Profile" style="width:150px;height:150px;border-radius:50%;cursor:pointer;">
  <input type="file" id="profile-upload" accept="image/*" style="display:none;">
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
  // 1️⃣ Initialize Supabase
  const supabaseUrl = "https://reels.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indxa25tc2lxYmp5em9zY2JiZ2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NTYwMTEsImV4cCI6MjA2ODIzMjAxMX0.KoDQ-JR8b2U7UNr_ZdYRtJmtqdFRKnjLROzbEOLM2TcY"; // replace with your anon key
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const profilePic = document.getElementById('profilePic');
  const profileInput = document.getElementById('profile-upload');
  const usernameEl = document.getElementById('username');

  // 2️⃣ Load user info
  async function loadProfile() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) {
      alert("Please log in first.");
      return;
    }

    // Set username
    const { data: profile } = await supabase
      .from('profiles') // replace with your table for username
      .select('username')
      .eq('id', user.id)
      .single();

    if (profile && profile.username) usernameEl.textContent = profile.username;

    // Set profile pic
    const { data: avatar } = await supabase
      .from('profile_picture') // table storing avatar_url
      .select('avatar_url')
      .eq('user_id', user.id)
      .single();

    if (avatar && avatar.avatar_url) profilePic.src = avatar.avatar_url;
  }

  loadProfile();

  // 3️⃣ Open file explorer when clicking image
  profilePic.addEventListener('click', () => profileInput.click());

  // 4️⃣ Upload new profile picture to Cloudinary & update Supabase
  profileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Upload to Cloudinary
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'profile_upload'); // your preset

    const res = await fetch('https://api.cloudinary.com/v1_1/dzorvvwp8/image/upload', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();

    if (data.secure_url) {
      profilePic.src = data.secure_url;

      // Save URL in Supabase
      const { data: upsertData, error } = await supabase
        .from('profile_picture')
        .upsert({
          user_id: supabase.auth.user().id,
          avatar_url: data.secure_url
        }, { onConflict: 'user_id' });

      if (error) console.error("Supabase update error:", error);
    }
  });
</script>
</body>
</html>
